---
// src/pages/dcs-diagnostic.astro
/**
 * DCS Diagnostic Page (Tier 2)
 * Minimal-diff implementation:
 * - Relies on Layout.astro defaults
 * - Telemetry gated by nt_system_ready (existing view script preserved)
 * - Netlify Forms: AJAX submit (POST "/") + GET redirect to thank-you (prevents POSTâ†’404)
 */
import Layout from '../layouts/Layout.astro';
import Tier2Telemetry from '../components/Tier2Telemetry.astro';
---

<Layout>
  <main class="tier2-main" data-nt-page="dcs_diagnostic">

    <!-- DCS Diagnostic Form -->
    <form
      id="dcs-diagnostic-form"
      name="dcs-diagnostic"
      method="POST"
      data-netlify="true"
      data-netlify-honeypot="bot-field"
      action="/dcs-diagnostic/thank-you/"
    >
      <input type="hidden" name="form-name" value="dcs-diagnostic" />

      <!-- Honeypot -->
      <p class="sr-only" aria-hidden="true">
        <label>Do not fill: <input name="bot-field" tabindex="-1" autocomplete="off" /></label>
      </p>

      <label>
        Website
        <input name="website" type="url" required autocomplete="url" />
      </label>

      <label>
        Name
        <input name="name" type="text" required autocomplete="name" />
      </label>

      <label>
        Email
        <input name="email" type="email" required autocomplete="email" />
      </label>

      <button id="dcs-submit-btn" type="submit">Run Diagnostic</button>
      <div id="dcs-form-error" style="display:none;" role="status" aria-live="polite"></div>
    </form>

    <!-- AJAX submit: POST "/" then GET redirect to thank-you (preserve GTM preview qs) -->
    <script is:inline>
      (function () {
        var form = document.getElementById("dcs-diagnostic-form");
        if (!form) return;

        var btn = document.getElementById("dcs-submit-btn");
        var err = document.getElementById("dcs-form-error");

        function getGtmPreviewQS() {
          var qs = window.location.search || "";
          if (!qs) return "";
          var hasPreview =
            qs.indexOf("gtm_debug=") !== -1 ||
            qs.indexOf("gtm_auth=") !== -1 ||
            qs.indexOf("gtm_preview=") !== -1;
          return hasPreview ? qs : "";
        }

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          if (btn) btn.disabled = true;
          if (err) { err.style.display = "none"; err.textContent = ""; }

          // Optional: intent push (namespaced)
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: "nt_form_submit",
            form_name: "dcs_diagnostic",
            form_location: "diagnostic_form",
            conversion_type: "dcs_diagnostic_request"
          });

          var formData = new FormData(form);
          var body = new URLSearchParams();
          for (var pair of formData.entries()) body.append(pair[0], String(pair[1]));

          fetch("/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: body.toString()
          })
            .then(function (res) {
              if (!res.ok) throw new Error("Netlify form submit failed: " + res.status);
              var qs = getGtmPreviewQS();
              window.location.assign("/dcs-diagnostic/thank-you/" + (qs || ""));
            })
            .catch(function (ex) {
              console.error(ex);
              if (btn) btn.disabled = false;
              if (err) {
                err.textContent = "Submission failed. Please try again.";
                err.style.display = "block";
              }
            });
        });
      })();
    </script>

    <!-- Existing Tier-2 view telemetry (kept) -->
    <script is:inline>
      (function () {
        window.dataLayer = window.dataLayer || [];

        var TIMEOUT_MS = 3000;
        var POLL_MS = 50;
        var elapsed = 0;

        var once = function (key, fn) {
          try {
            if (sessionStorage.getItem(key)) return;
            sessionStorage.setItem(key, "1");
          } catch (e) {}
          fn();
        };

        var fire = function () {
          once("nt_dcs_diag_view", function () {
            window.dataLayer.push({
              event: "nt_dcs_diag_view",
              nt_event_source: "tier2",
              page_path: location.pathname,
              page_title: document.title
            });
          });
        };

        var hasSystemReady = function () {
          try {
            for (var i = window.dataLayer.length - 1; i >= 0; i--) {
              if (window.dataLayer[i] && window.dataLayer[i].event === "nt_system_ready") return true;
            }
          } catch (e) {}
          return false;
        };

        var wait = function () {
          if (hasSystemReady()) { fire(); return; }
          if (elapsed < TIMEOUT_MS) { elapsed += POLL_MS; setTimeout(wait, POLL_MS); }
          // fail-closed for view event, as originally implemented
        };

        wait();
      })();
    </script>

    <!-- Your existing page sections/content can remain below here -->
    <!-- (Symptoms / Reframing / DCS Definition / Telemetry Value / Outcomes / CTA) -->

    <Tier2Telemetry />
  </main>
</Layout>
