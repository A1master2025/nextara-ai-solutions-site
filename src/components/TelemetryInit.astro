---
/**
 * TelemetryInit.astro
 * NexTara DIOS Telemetry Initialization
 * 
 * Emits nt_system_ready when site is fully loaded and usable.
 * Canonical telemetry start event for telemetry-first model.
 * 
 * GTM fires GA4 Config and nt_page_view on this event.
 * No user permission required. No consent gating.
 */
---
<script>
  (function() {
    'use strict';
    
    // Duplicate emission guard
    if (window.__NT_SYSTEM_READY_EMITTED__) {
      return;
    }
    
    window.dataLayer = window.dataLayer || [];
    
    function emitSystemReady() {
      if (window.__NT_SYSTEM_READY_EMITTED__) {
        return;
      }
      window.__NT_SYSTEM_READY_EMITTED__ = true;
      
      requestAnimationFrame(function() {
        var payload = {
          event: 'nt_system_ready',
          nt_event_source: 'system',
          page_location: window.location.href,
          page_path: window.location.pathname,
          page_title: document.title
        };
        
        window.dataLayer.push(payload);
        
        // Debug logging (activate via ?nt_debug=1)
        if (window.location.search.indexOf('nt_debug=1') > -1) {
          console.log('[NexTara DIOS] nt_system_ready emitted:', payload);
        }
      });
    }
    
    if (document.readyState === 'complete') {
      emitSystemReady();
    } else {
      window.addEventListener('load', emitSystemReady, { once: true });
    }
  })();
</script>