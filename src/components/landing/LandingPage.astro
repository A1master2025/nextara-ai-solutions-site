---
// src/components/landing/LandingPage.astro
import type { Landing } from "../../data/landings";

type Props = {
  landing: Landing;
};

const { landing } = Astro.props;

const {
  hero,
  proof,
  howItWorks,
  deliverables,
  fit,
  faq,
  finalCta,
  seo,
} = landing;

// Simple ID used for the “Run” anchor for suppression-screen
const runAnchorId = "run";

// Only show the "Run" form on the suppression-screen landing
const canonicalPath = (seo as any)?.canonicalPath ?? "";
const isSuppressionScreen = String(canonicalPath).includes("/landing/suppression-screen");
---

<section style="max-width: 980px; margin: 0 auto; padding: 48px 20px;">
  <header style="margin-bottom: 28px;">
    <h1 style="font-size: 40px; line-height: 1.1; margin: 0 0 12px;">
      {hero.headline}
    </h1>
    <p style="font-size: 18px; margin: 0 0 18px;">
      {hero.subheadline}
    </p>

    {hero.disclaimer ? (
      <p style="font-size: 14px; opacity: 0.85; margin: 0 0 18px;">
        {hero.disclaimer}
      </p>
    ) : null}

    {hero.bullets?.length ? (
      <ul style="margin: 0 0 22px; padding-left: 18px;">
        {hero.bullets.map((b) => <li style="margin: 6px 0;">{b}</li>)}
      </ul>
    ) : null}

    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
      <a
        href={hero.primaryCta.href}
        data-gtm-event={hero.primaryCta.gtmEvent}
        style="display: inline-block; padding: 12px 16px; border: 1px solid #111; text-decoration: none;"
      >
        {hero.primaryCta.label}
      </a>

      {hero.secondaryCta ? (
        <a
          href={hero.secondaryCta.href}
          data-gtm-event={hero.secondaryCta.gtmEvent}
          style="display: inline-block; padding: 12px 16px; border: 1px solid #888; text-decoration: none;"
        >
          {hero.secondaryCta.label}
        </a>
      ) : null}
    </div>

    {hero.primaryCta.description ? (
      <p style="font-size: 14px; opacity: 0.85; margin: 12px 0 0;">
        {hero.primaryCta.description}
      </p>
    ) : null}
  </header>

  {/* “Run” section anchor for suppression-screen */}
  <div id={runAnchorId} style="height: 1px;"></div>

  {/* Suppression Screen Run UI (only on /landing/suppression-screen/) */}
  {isSuppressionScreen ? (
    <section style="margin: 28px 0; padding: 18px; border: 1px solid #111;">
      <h2 style="margin: 0 0 10px;">Run the Suppression Screen</h2>
      <p style="margin: 0 0 14px; font-size: 14px; opacity: 0.85;">
        Enter a full URL (include https://). Example: https://example.com
      </p>

      <form id="ss-form" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <input
          id="ss-url"
          name="url"
          type="url"
          placeholder="https://example.com"
          required
          style="flex: 1; min-width: 260px; padding: 10px 12px; border: 1px solid #888;"
        />
        <button
          type="submit"
          style="padding: 10px 14px; border: 1px solid #111; background: transparent; cursor: pointer;"
        >
          Run scan
        </button>
      </form>

      <div id="ss-status" style="margin-top: 12px; font-size: 14px; opacity: 0.85;"></div>

      <pre
        id="ss-output"
        style="margin-top: 12px; padding: 12px; border: 1px solid #ddd; white-space: pre-wrap; word-break: break-word; font-size: 12px; line-height: 1.35; max-height: 420px; overflow: auto;"
      ></pre>

      <script>
        (function () {
          const form = document.getElementById("ss-form");
          const input = document.getElementById("ss-url");
          const statusEl = document.getElementById("ss-status");
          const outEl = document.getElementById("ss-output");

          if (!form || !input || !statusEl || !outEl) return;

          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const url = (input.value || "").trim();
            outEl.textContent = "";
            statusEl.textContent = "";

            if (!url) {
              statusEl.textContent = "Please enter a URL.";
              return;
            }

            try {
              statusEl.textContent = "Running scan...";
              const endpoint = "/.netlify/functions/suppression-screen?url=" + encodeURIComponent(url);
              const res = await fetch(endpoint, { method: "GET" });
              const json = await res.json();

              if (!res.ok) {
                statusEl.textContent = "Error: " + (json?.error_message || res.statusText);
                const risk = json?.result?.risk_level || "UNKNOWN";
const counts = json?.result?.counts || {};
const proof = json?.proof || {};
const ctaPrimary = json?.cta?.primary || {};
const ctaSecondary = json?.cta?.secondary || {};

const summary =
  `Risk Level: ${risk}\n` +
  `Counts: P0=${counts.p0 ?? 0}, P1=${counts.p1 ?? 0}, P2=${counts.p2 ?? 0}, P3=${counts.p3 ?? 0}\n\n` +
  `Proof Finding: ${proof.finding ?? ""}\n` +
  `Severity: ${proof.severity ?? ""} | Category: ${proof.category ?? ""}\n` +
  `Evidence URL: ${proof.evidence?.url ?? ""}\n` +
  `Evidence Snippet: ${proof.evidence?.snippet ?? ""}\n\n` +
  `Why it suppresses: ${proof.why_it_suppresses ?? ""}\n\n` +
  `How to verify: ${proof.how_to_verify ?? ""}\n\n` +
  `Primary CTA: ${ctaPrimary.label ?? ""}\n` +
  `Secondary CTA: ${ctaSecondary.label ?? ""}\n`;

outEl.textContent = summary;
                return;
              }

              statusEl.textContent = "Scan complete.";
              outEl.textContent = JSON.stringify(json, null, 2);
            } catch (err) {
              statusEl.textContent = "Scan failed (network/runtime error).";
              outEl.textContent = String(err);
            }
          });
        })();
      </script>
    </section>
  ) : null}

  {proof ? (
    <section style="margin: 36px 0; padding: 18px; border: 1px solid #ddd;">
      <h2 style="margin: 0 0 10px;">{proof.title}</h2>
      <ul style="margin: 0; padding-left: 18px;">
        {proof.bullets.map((b) => <li style="margin: 6px 0;">{b}</li>)}
      </ul>
      {proof.note ? (
        <p style="margin: 12px 0 0; font-size: 14px; opacity: 0.85;">
          {proof.note}
        </p>
      ) : null}
    </section>
  ) : null}

  {howItWorks ? (
    <section style="margin: 36px 0;">
      <h2 style="margin: 0 0 12px;">{howItWorks.title}</h2>
      <ol style="margin: 0; padding-left: 18px;">
        {howItWorks.steps.map((s) => (
          <li style="margin: 10px 0;">
            <strong>{s.title}:</strong> {s.description}
          </li>
        ))}
      </ol>
    </section>
  ) : null}

  {deliverables ? (
    <section style="margin: 36px 0;">
      <h2 style="margin: 0 0 12px;">{deliverables.title}</h2>
      <ul style="margin: 0; padding-left: 18px;">
        {deliverables.items.map((i) => <li style="margin: 6px 0;">{i}</li>)}
      </ul>
      {deliverables.note ? (
        <p style="margin: 12px 0 0; font-size: 14px; opacity: 0.85;">
          {deliverables.note}
        </p>
      ) : null}
    </section>
  ) : null}

  {fit ? (
    <section style="margin: 36px 0;">
      <h2 style="margin: 0 0 12px;">{fit.title}</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div style="border: 1px solid #ddd; padding: 14px;">
          <h3 style="margin: 0 0 8px;">Good fit</h3>
          <ul style="margin: 0; padding-left: 18px;">
            {fit.goodFit.map((i) => <li style="margin: 6px 0;">{i}</li>)}
          </ul>
        </div>
        <div style="border: 1px solid #ddd; padding: 14px;">
          <h3 style="margin: 0 0 8px;">Not a fit</h3>
          <ul style="margin: 0; padding-left: 18px;">
            {fit.notAfit.map((i) => <li style="margin: 6px 0;">{i}</li>)}
          </ul>
        </div>
      </div>
    </section>
  ) : null}

  {faq?.length ? (
    <section style="margin: 36px 0;">
      <h2 style="margin: 0 0 12px;">FAQ</h2>
      <div style="display: grid; gap: 10px;">
        {faq.map((item) => (
          <details style="border: 1px solid #ddd; padding: 12px;">
            <summary style="cursor: pointer; font-weight: 600;">
              {item.q}
            </summary>
            <p style="margin: 10px 0 0;">{item.a}</p>
          </details>
        ))}
      </div>
    </section>
  ) : null}

  {finalCta ? (
    <section style="margin: 44px 0; padding: 18px; border: 1px solid #111;">
      <h2 style="margin: 0 0 10px;">{finalCta.title}</h2>

      {finalCta.note ? (
        <p style="margin: 0 0 14px; font-size: 14px; opacity: 0.85;">
          {finalCta.note}
        </p>
      ) : null}

      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <a
          href={finalCta.primaryCta.href}
          data-gtm-event={finalCta.primaryCta.gtmEvent}
          style="display: inline-block; padding: 12px 16px; border: 1px solid #111; text-decoration: none;"
        >
          {finalCta.primaryCta.label}
        </a>

        {finalCta.secondaryCta ? (
          <a
            href={finalCta.secondaryCta.href}
            data-gtm-event={finalCta.secondaryCta.gtmEvent}
            style="display: inline-block; padding: 12px 16px; border: 1px solid #888; text-decoration: none;"
          >
            {finalCta.secondaryCta.label}
          </a>
        ) : null}
      </div>
    </section>
  ) : null}
</section>
